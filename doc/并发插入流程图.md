# 并发插入流程图

```mermaid
sequenceDiagram
    participant T1 as 线程1
    participant T2 as 线程2
    participant T3 as 线程3
    participant BPT as BPlusTree
    participant BPM as BufferPoolManager
    participant DM as DiskManager
    
    Note over T1,T3: 并发插入操作开始
    
    par 线程1插入操作
        T1->>BPT: Insert(key1, value1, &transaction)
        Note over T1,BPT: 获取全局写锁 (std::lock_guard)
        alt 树为空
            T1->>BPT: Start_New_Tree(key1, value1)
            T1->>BPM: NewPageGuard(&page_id)
            T1->>DM: AllocatePage()
            T1->>BPT: 创建根节点并插入数据
        else 树不为空
            T1->>BPT: Find_Leaf_Guard(key1)
            T1->>BPM: FetchPageGuard(leaf_page_id)
            T1->>BPT: 在叶子节点插入数据
            alt 叶子节点已满
                T1->>BPT: Handle_Split(leaf_guard)
                T1->>BPM: NewPageGuard(&new_page_id)
                T1->>BPT: 分裂叶子节点
                T1->>BPT: 更新父节点
            end
        end
        Note over T1,BPT: 释放全局写锁
        T1-->>T1: 返回插入结果
    and 线程2插入操作
        T2->>BPT: Insert(key2, value2, &transaction)
        Note over T2,BPT: 等待全局写锁
        Note over T2,BPT: 获取全局写锁 (std::lock_guard)
        T2->>BPT: Find_Leaf_Guard(key2)
        T2->>BPM: FetchPageGuard(leaf_page_id)
        T2->>BPT: 在叶子节点插入数据
        Note over T2,BPT: 释放全局写锁
        T2-->>T2: 返回插入结果
    and 线程3插入操作
        T3->>BPT: Insert(key3, value3, &transaction)
        Note over T3,BPT: 等待全局写锁
        Note over T3,BPT: 获取全局写锁 (std::lock_guard)
        T3->>BPT: Find_Leaf_Guard(key3)
        T3->>BPM: FetchPageGuard(leaf_page_id)
        T3->>BPT: 在叶子节点插入数据
        Note over T3,BPT: 释放全局写锁
        T3-->>T3: 返回插入结果
    end
    
    Note over T1,T3: 所有插入操作完成
```

## 关键同步机制

### 1. 全局写锁
- 使用 `std::shared_mutex root_latch_` 作为全局写锁
- 所有插入操作都需要获取独占锁 `std::lock_guard<std::shared_mutex>`
- 确保同一时间只有一个线程可以修改树结构

### 2. 页面管理
- 使用 `PageGuard` 进行自动页面管理
- 页面在作用域结束时自动释放
- 脏页面自动标记并最终写回磁盘

### 3. 事务支持
- 虽然定义了 `Transaction` 类，但当前实现中未实际使用
- 预留了事务接口以支持未来的事务功能

## 并发安全性保证

1. **原子性**: 每个插入操作要么完全成功，要么完全失败
2. **一致性**: 通过全局锁保证树结构的一致性
3. **隔离性**: 写操作之间完全隔离，不会相互干扰
4. **持久性**: 通过缓冲池管理器确保数据最终持久化到磁盘

## 性能考虑

1. **锁粒度**: 使用全局锁可能影响并发性能
2. **页面缓存**: 利用缓冲池减少磁盘I/O
3. **批量操作**: 支持批量插入以提高效率

## 注意事项

1. 当前实现使用粗粒度锁，可能在高并发场景下成为性能瓶颈
2. 分裂操作需要更新父节点，可能涉及多个页面的修改
3. 事务参数虽然存在但未实际使用，为未来扩展预留接口
